import json
import boto3
import requests
from datetime import datetime

# Configuração básica com sua chave de API do TMDB
tmdb_api_key = '1af2f2525262ee4cd8d7926245f782bd'

def lambda_handler(event, context):
    # URL da API do TMDB para buscar séries de TV de Drama e Romance
    url = "https://api.themoviedb.org/3/discover/tv"
    
    # Parâmetros da requisição GET
    params = {
        'api_key': tmdb_api_key,
        'include_adult': False,
        'include_video': False,
        'language': 'en-US',
        'sort_by': 'vote_average.desc',
        'with_genres': '18',  # Drama
        'vote_count.gte': 200,  # Pelo menos 200 votos
        'page': 1
    }
    
    # Fazendo a requisição GET para a API do TMDB usando requests
    response = requests.get(url, params=params)
    response.raise_for_status()  # Lança exceção se a requisição falhar
    
    # Convertendo a resposta JSON em um dicionário Python
    response_data = response.json()
    top_tv_shows = response_data.get('results', [])[:20]  # Limitando a 20 séries
    
    top_tv_shows_info = []
    for show in top_tv_shows:
        show_info = {
            'Title': show['name'],
            'Popularity': show['popularity'],
            'Vote_Average': show['vote_average'],
            'Vote_Count': show['vote_count']
        }
        top_tv_shows_info.append(show_info)
    
    # Timestamp atual para o path de data
    current_date = datetime.now().strftime("%Y/%m/%d")
    
    # Nome do arquivo de saída com o padrão de path especificado
    output_filename = f"Raw/TMDB/JSON/{current_date}/top_drama_tv_shows.json"
    
    # Salvar informações das séries de TV em um arquivo JSON no S3
    s3_client = boto3.client('s3')
    s3_client.put_object(Bucket='data-lake-do-allan', Key=output_filename, Body=json.dumps(top_tv_shows_info, indent=4, ensure_ascii=False))
    print(f"Arquivo JSON salvo em: s3://data-lake-do-allan/{output_filename}")
    
    return {
        'statusCode': 200,
        'body': json.dumps(f'Processamento concluído. Total de séries processadas: {len(top_tv_shows_info)}')
    }
